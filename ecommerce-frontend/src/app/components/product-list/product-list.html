<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2>Our Products</h2>
          <p class="text-muted">Discover our amazing collection of products</p>
        </div>
        @if (isAdmin) {
          <button class="btn btn-success" (click)="openAddProductModal()">
            <i class="fas fa-plus me-2"></i>Add New Product
          </button>
        }
      </div>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="text-muted me-2">Filter by category:</span>
        <button 
          class="btn btn-sm"
          [class.btn-primary]="selectedCategoryFilter === ''"
          [class.btn-outline-primary]="selectedCategoryFilter !== ''"
          (click)="clearFilter()">
          All Products
        </button>
        @for (category of categories; track category.id) {
          <button 
            class="btn btn-sm"
            [class.btn-primary]="selectedCategoryFilter === category.name"
            [class.btn-outline-primary]="selectedCategoryFilter !== category.name"
            (click)="filterByCategory(category.name)">
            {{ category.name }}
          </button>
        }
      </div>
    </div>
  </div>

  @if (loading) {
    <div class="row">
      <div class="col-12 text-center">
        <div class="spinner-border" aria-label="Loading">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading products...</p>
      </div>
    </div>
  } @else if (filteredProducts.length === 0) {
    <div class="row">
      <div class="col-12 text-center">
        <div class="alert alert-warning">
          @if (selectedCategoryFilter) {
            <h4>No products found in "{{ selectedCategoryFilter }}" category</h4>
            <p class="text-muted">Try selecting a different category or browse all products.</p>
            <button class="btn btn-primary" (click)="clearFilter()">Show All Products</button>
          } @else {
            <h4>No products available</h4>
            <p class="text-muted">Please check back later or contact support.</p>
            <button class="btn btn-primary" (click)="loadProducts()">Try Again</button>
          }
        </div>
      </div>
    </div>
  } @else {
    <div class="row">
      @for (product of filteredProducts; track product.id) {
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
          <div class="card h-100">
            <img 
              [src]="getImageUrl(product.imageUrl)" 
              class="card-img-top" 
              [alt]="product.name" 
              style="height: 200px; object-fit: cover; cursor: pointer;"
              (click)="viewProduct(product.id)"
              (error)="onImageError($event)">
            <div class="card-body d-flex flex-column">
              <h5 
                class="card-title" 
                style="cursor: pointer;" 
                (click)="viewProduct(product.id)">
                {{ product.name }}
              </h5>
              <p class="card-text text-muted">{{ product.description }}</p>
              <p class="card-text"><strong>${{ product.price }}</strong></p>
              <div class="mt-auto">
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-primary" (click)="viewProduct(product.id)">
                    View Details
                  </button>
                  <button 
                    class="btn btn-primary" 
                    (click)="addToCart(product)"
                    [disabled]="product.stockQuantity === 0">
                    <i class="fas fa-cart-plus me-2"></i>
                    {{ product.stockQuantity === 0 ? 'Out of Stock' : 'Add to Cart' }}
                  </button>
                  @if (isAdmin) {
                    <button class="btn btn-outline-danger btn-sm" (click)="deleteProduct(product.id)">
                      <i class="fas fa-trash me-1"></i>Delete
                    </button>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Add Product Modal -->
@if (showAddProductModal) {
  <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Product</h5>
          <button type="button" class="btn-close" (click)="closeAddProductModal()"></button>
        </div>
        <form [formGroup]="addProductForm" (ngSubmit)="onSubmitProduct()">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="productName" class="form-label">Product Name *</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="productName"
                    formControlName="name"
                    [class.is-invalid]="addProductForm.get('name')?.invalid && addProductForm.get('name')?.touched">
                  <div class="invalid-feedback">
                    Product name is required (minimum 2 characters)
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="productCategory" class="form-label">Category *</label>
                  <select 
                    class="form-select" 
                    id="productCategory"
                    formControlName="category"
                    [class.is-invalid]="addProductForm.get('category')?.invalid && addProductForm.get('category')?.touched">
                    <option value="">Select a category</option>
                    @for (category of categories; track category.id) {
                      <option [value]="category.name">{{ category.name }}</option>
                    }
                  </select>
                  <div class="invalid-feedback">
                    Category is required
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="productDescription" class="form-label">Description *</label>
              <textarea 
                class="form-control" 
                id="productDescription"
                rows="3"
                formControlName="description"
                [class.is-invalid]="addProductForm.get('description')?.invalid && addProductForm.get('description')?.touched"></textarea>
              <div class="invalid-feedback">
                Description is required (minimum 10 characters)
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="productPrice" class="form-label">Price *</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="productPrice"
                      step="0.01"
                      min="0.01"
                      formControlName="price"
                      [class.is-invalid]="addProductForm.get('price')?.invalid && addProductForm.get('price')?.touched">
                  </div>
                  <div class="invalid-feedback">
                    Price must be greater than 0
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="productStock" class="form-label">Stock Quantity *</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    id="productStock"
                    min="0"
                    formControlName="stockQuantity"
                    [class.is-invalid]="addProductForm.get('stockQuantity')?.invalid && addProductForm.get('stockQuantity')?.touched">
                  <div class="invalid-feedback">
                    Stock quantity must be 0 or greater
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="productImage" class="form-label">Product Image *</label>
              <input 
                type="file" 
                class="form-control" 
                id="productImage"
                accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                (change)="onFileSelected($event)"
                required>
              @if (selectedFile) {
                <div class="mt-2 text-success">
                  <i class="fas fa-check-circle me-1"></i>
                  Selected: {{ selectedFile.name }}
                </div>
              }
              <small class="form-text text-muted">
                Select an image file (JPEG, PNG, GIF, or WebP). Maximum file size: 5MB.
              </small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeAddProductModal()" [disabled]="isCreatingProduct">
              Cancel
            </button>
            <button type="submit" class="btn btn-success" [disabled]="addProductForm.invalid || isCreatingProduct || !selectedFile">
              @if (isCreatingProduct) {
                <span class="spinner-border spinner-border-sm me-2"></span>
                Creating...
              } @else {
                <i class="fas fa-plus me-2"></i>Create Product
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}
